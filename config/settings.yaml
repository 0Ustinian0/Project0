# 日志：目录、保留数量、单文件模式
logging:
  log_dir: logs
  # 单文件：设为 "latest.log" 则每次覆盖；不设则按时间戳新建 backtest_YYYYMMDD_HHMMSS.log
  file_name: null
  retain_count: 10   # 时间戳模式时仅保留最近 N 个文件，其余自动删除
  quiet_console_init: false

# 回测配置
backtest:
  universe: SP500       # 数据源名称 (对应 data/SP500/)
  data_dir: data/SP500  # 股票 CSV 目录
  universe_size: 100   # null=全市场(会按 SPY 日历对齐，避免多标的不同步导致无交易), 50=快速测试
  universe_seed: 243 # 有值时按种子随机取前 N（可复现）；null=按文件名排序取前 N（与改前行为一致）
  initial_capital: 100000.0
  commission: 0.0005    # 万5佣金
  slippage: 0.0005      # 万5滑点 (可选，默认0)
  start_date: "2024-01-01"
  end_date: "2026-01-01"

# 策略参数 (会覆盖 strategy/strategy.py 中的 params 默认值)
strategy:
  max_pos: 10
  risk_per_trade_pct: 0.015
  debug: true
  lookback_period: 20
  entry_threshold: 0.02
  exit_threshold: -0.01
  min_price: 10.0
  min_dollar_vol: 15000000
  min_avg_dollar_vol: 12000000
  atr_period: 14
  rsi_period: 14
  stop_atr_mult: 3.5
  # 动态 ATR 倍数：按波动率(ATR/Price)分组 + 按板块(Sector)系数微调
  dynamic_stop_enabled: true
  atr_pct_low: 0.02      # <=2% 视为低波动（止损更紧）
  atr_pct_high: 0.05     # >=5% 视为高波动（止损更宽）
  stop_mult_low_vol: 2.2   # 低波动：从 2.5 收紧到 2.2，更早锁盈
  stop_mult_high_vol: 3.0  # 高波动：从 3.6 收紧到 3.0，减少深回撤
  # 板块系数（可按你数据里的 Sector 名称改）：mult = mult * factor
  sector_stop_mult_factors:
    Technology: 1.15
    Communication Services: 1.10
    Consumer Discretionary: 1.05
    Utilities: 0.90
    Consumer Staples: 0.95
  # 量比过滤：当日量 >= Volume_MA20 * vol_multiplier 才入池；null 表示不启用
  vol_multiplier: null
  # 时间止损：买入后 N 天未涨则市价清仓；time_stop_enabled: false 则关闭
  time_stop_enabled: false
  time_stop_days: 20
  # RSI 超买止盈：RSI > 阈值时分批减仓（比例）
  rsi_overbought: 80
  rsi_reduce_pct: 0.5
  # 移动止盈：价格创新高后，回撤超过 take_profit_pct 时止盈（如 0.05 = 5% 回撤）
  take_profit_enabled: true
  take_profit_pct: 0.03   # 从 5% 收紧到 3%，更早吃到回撤
  # 分批止盈：浮盈达到不同 ATR 倍数时分别止盈一部分（如 0.8/1.5/2.5 ATR 止盈 30%/30%/40%）
  take_profit_atr_enabled: true
  take_profit_atr_levels: [0.8, 1.5, 2.5]   # 更早开始分批（原来是 1/2/3 ATR）
  take_profit_atr_pcts: [0.3, 0.3, 0.4]     # 50%/25%/25%
  # 末位淘汰安全阀：保护“及格持仓”和“大赢家”
  replace_protect_enabled: true
  replace_good_score_floor: 60        # 持仓得分 ≥ 60 不替换
  replace_good_above_ma20: true       # 价格在 MA20 之上不替换
  replace_weak_rsi_floor: 50          # RSI < 50 视为走弱（满足“走弱”才允许替换）
  replace_winner_protect_pct: 0.10    # 浮盈 ≥ 10% 不替换
  replace_stronger_ratio: 1.2         # 新股得分需 > 旧股得分*1.2 才替换
  # 基本面过滤（fundamentals.csv 含 Ticker, PE, PB, ROE, RevenueGrowth, DebtToEquity, Sector, EPS_Growth）
  # 适度收紧：PE/成长/ROE 选更优标的；min_dollar_vol + min_avg_dollar_vol 保证成交充足；候选为 0 时宽松回退
  fundamentals_enabled: true
  max_pe: 50
  min_roe: 0
  max_pb: 80
  min_revenue_growth: -0.15
  max_debt_to_equity: 400
  min_eps_growth: 0.05
  sector: null
  top_n: 8
  min_candidates_after_fundamentals: 1

# 参数优化：python main.py --optimize | --optimize-wfa | --optimize-bayesian
optimization:
  enabled: false
  # 优化方式：grid（默认）| walk_forward | bayesian；CLI --optimize-wfa / --optimize-bayesian 会覆盖此项
  method: grid
  # 目标指标: sharperatio | final_value | drawdown | cagr | calmar | sortino | win_rate | profit_factor | composite
  metric: sharperatio
  maximize: true
  # 多指标综合：metric=composite 时用 composite_preset 或 composite_weights
  composite_preset: null   # balanced | aggressive | conservative（三选一）
  # composite_weights:  # 或直接写权重（与 composite_preset 二选一）
  #   sharperatio: 0.3
  #   calmar: 0.3
  #   win_rate: 0.2
  #   profit_factor: 0.2
  # 参数网格：每参数「列表」= 参与优化，「null/false」= 不优化、用 strategy 默认值
  param_grid:
    atr_period: [10, 14, 20]      # 列表=优化该参数
    rsi_period: null #[10, 14]
    risk_per_trade_pct: [0.02, 0.03, 0.04]
    stop_atr_mult: null #[3.0, 3.5, 4.0]
    vol_multiplier: null          # null/false=不优化，用 strategy 默认
  max_combos: 36          # 组合数上限，超过则抽样（不设则不限制）
  random_state: 42
  # SMA200 等需约 252 个交易日；252 个日历日仅约 174 个交易日会触发 IndexError，故 train/lookback 至少 365 天
  walk_forward_train_days: 365
  walk_forward_test_days: 63
  walk_forward_lookback_days: 365
  bayesian_n_calls: 25    # 贝叶斯迭代次数，不宜过大
  final_params_method: cluster   # best | plateau | plateau_freq | plateau_kde | cluster | robust
  plateau_top_pct: 0.2
  robust_alpha: 0.7
  robust_radius: 1
  n_clusters: 3
  run_final_backtest: true
  run_validation: false

# 多策略并行：各策略独立资金按权重运行，再合并收益曲线 (python main.py --multi-strategy)
multi_strategy:
  enabled: false
  strategies:
    - name: screener
      params: { max_pos: 10, risk_per_trade_pct: 0.03, debug: false }
      weight: 0.5
    - name: screener
      params: { max_pos: 5, risk_per_trade_pct: 0.02, debug: false }
      weight: 0.5
